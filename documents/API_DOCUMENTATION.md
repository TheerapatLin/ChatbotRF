# ChatBot API Documentation

**Version:** 6.7 (2025-11-10)
**Base URL:** `http://localhost:3001`

---

## üöÄ Quick Start

```bash
# 1. Setup PostgreSQL
docker-compose up -d

# 2. Configure environment
cp backend/.env.development backend/.env
# Edit .env with your API keys

# 3. Install dependencies
cd backend && go mod download

# 4. Run server
go run main.go  # or use 'air' for hot reload
```

---

## üìã Architecture

**Pattern:** Repository-Service-Controller

```
Client Request
    ‚Üì
Routes (routes.go)
    ‚Üì
Controllers (business logic entry)
    ‚Üì
Services (external API calls, business logic)
    ‚Üì
Repositories (database operations)
    ‚Üì
Database (PostgreSQL)
```

**Tech Stack:**
- **Framework:** Go Fiber v2
- **ORM:** GORM
- **Database:** PostgreSQL 15
- **AI Providers:** OpenAI GPT-4, AWS Bedrock Claude Sonnet 4
- **Speech-to-Text:** Whisper.cpp (local), OpenAI Whisper API
- **Text-to-Speech:** OpenAI TTS, ElevenLabs
- **WebSocket:** Fiber WebSocket adapter
- **File Processing:** PDF/DOCX/XLSX extraction libraries

---

## üìö API Endpoints

### Health Check
```
GET /api/health
```

---

## 1. ü§ñ Personas API

**Personas** = AI personalities with different configurations (tone, expertise, model)

### List All Personas
```
GET /api/personas
```

**Response:**
```json
{
  "personas": [{
    "id": 1,
    "name": "General Assistant",
    "description": "‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡πÄ‡∏ô‡∏Å‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå",
    "tone": "friendly",
    "style": "conversational",
    "expertise": "general",
    "temperature": 0.7,
    "max_tokens": 2000,
    "model": "gpt-4o-mini",
    "icon": "ü§ñ"
  }]
}
```

### Get Persona by ID
```
GET /api/personas/:id
```

**Response:** Same as above + usage statistics

---

### Create New Persona
```
POST /api/personas
```

**Request:**
```json
{
  "name": "Marketing Expert",
  "description": "AI ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î",
  "system_prompt": "You are a marketing expert...",
  "tone": "professional",
  "style": "detailed",
  "expertise": "marketing",
  "temperature": 0.6,
  "max_tokens": 2500,
  "model": "gpt-4o-mini",
  "language_setting": {
    "default_language": "th",
    "response_style": "formal",
    "language_code": "th-TH"
  },
  "guardrails": {
    "block_profanity": true,
    "block_sensitive": false,
    "allowed_topics": ["marketing", "business", "advertising"],
    "blocked_topics": ["politics", "religion"],
    "max_response_length": 3000,
    "require_moderation": false
  },
  "icon": "üìà"
}
```

**Response (201 Created):**
```json
{
  "id": 9,
  "name": "Marketing Expert",
  "description": "AI ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î",
  "tone": "professional",
  "style": "detailed",
  "expertise": "marketing",
  "temperature": 0.6,
  "max_tokens": 2500,
  "model": "gpt-4o-mini",
  "language_setting": "{\"default_language\":\"th\",\"response_style\":\"formal\",\"language_code\":\"th-TH\"}",
  "guardrails": "{\"block_profanity\":true,\"block_sensitive\":false,\"allowed_topics\":[\"marketing\",\"business\",\"advertising\"],\"blocked_topics\":[\"politics\",\"religion\"],\"max_response_length\":3000,\"require_moderation\":false}",
  "icon": "üìà",
  "is_active": true
}
```

**Field Details:**
- `name` (required, max 100 chars) - Persona name
- `description` (required) - Description
- `system_prompt` (required) - AI instructions
- `tone` (max 200 chars) - friendly/professional/empathetic (default: friendly)
- `style` (max 500 chars) - conversational/detailed/concise (default: conversational)
- `expertise` (max 500 chars) - general/technology/marketing/etc (default: general)
- `temperature` (0.0-2.0) - AI creativity level (default: 0.7)
- `max_tokens` - Response limit (default: 2000)
- `model` - AI model (default: gpt-4o-mini)
- `language_setting` - Language preferences (JSON object)
- `guardrails` - Content filters and rules (JSON object)
- `icon` (max 10 chars) - Emoji (default: ü§ñ)

**Valid Models:**
- OpenAI: `gpt-4o-mini`, `gpt-4o`, `gpt-4`, `gpt-3.5-turbo`
- Claude: `claude-sonnet-4`, `claude-3-opus`, `claude-3-sonnet`
- AWS Bedrock: `apac.anthropic.claude-sonnet-4-20250514-v1:0`

**Validation Rules:**
- Required fields must not be empty
- Field length limits must be respected
- Model name must be from valid models list
- Temperature must be between 0.0 and 2.0

**Note:** ID is auto-generated by database

**Error Responses:**
```json
{
  "error": "Invalid model name",
  "valid_models": ["gpt-4o-mini", "gpt-4o", "gpt-4", "gpt-3.5-turbo", "claude-sonnet-4", "claude-3-opus", "claude-3-sonnet"],
  "received": "invalid-model"
}
```

---

### Update Persona
```
PATCH /api/persona/:id
```

**URL Parameters:**
- `id` (integer) - Persona ID to update

**Request Body (Partial Update):**
All fields are optional - only send fields you want to update
```json
{
  "name": "Marketing Expert Pro",
  "description": "‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏• (‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï)",
  "system_prompt": "You are an advanced marketing expert...",
  "tone": "professional",
  "style": "analytical",
  "expertise": "digital marketing, SEO, content strategy",
  "temperature": 0.8,
  "max_tokens": 3000,
  "model": "gpt-4o",
  "icon": "üìä",
  "is_active": true,
  "language_setting": {
    "default_language": "en",
    "response_style": "formal",
    "language_code": "en-US"
  },
  "guardrails": {
    "block_profanity": false,
    "block_sensitive": true,
    "allowed_topics": ["marketing", "business", "analytics"],
    "blocked_topics": [],
    "max_response_length": 5000,
    "require_moderation": false
  }
}
```

**Response (200 OK):**
```json
{
  "id": 9,
  "name": "Marketing Expert Pro",
  "description": "‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏• (‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï)",
  "tone": "professional",
  "style": "analytical",
  "expertise": "digital marketing, SEO, content strategy",
  "temperature": 0.8,
  "max_tokens": 3000,
  "model": "gpt-4o",
  "language_setting": "{\"default_language\":\"en\",\"response_style\":\"formal\",\"language_code\":\"en-US\"}",
  "guardrails": "{\"block_profanity\":false,\"block_sensitive\":true,...}",
  "icon": "üìä",
  "is_active": true
}
```

**Validation Rules:**
- Same as Create Persona endpoint
- Name: max 100 chars (cannot be empty if provided)
- Tone: max 200 chars
- Style: max 500 chars
- Expertise: max 500 chars
- Temperature: 0.0-2.0
- Model: must be valid model name
- Icon: max 10 chars
- System prompt: cannot be empty if provided

**Error Responses:**
```json
// 400 Bad Request - Invalid ID
{
  "error": "Invalid persona ID"
}

// 404 Not Found - Persona doesn't exist
{
  "error": "Persona not found"
}

// 400 Bad Request - Validation error
{
  "error": "Temperature must be between 0.0 and 2.0"
}

// 500 Internal Server Error
{
  "error": "Failed to update persona"
}
```

---

### Delete Persona
```
DELETE /api/persona/:id
```

**URL Parameters:**
- `id` (integer) - Persona ID to delete

**Behavior:**
- Deletes all messages associated with the persona first (cascade delete)
- Then deletes the persona itself
- Returns count of deleted messages

**Response (200 OK):**
```json
{
  "message": "Persona deleted successfully",
  "id": 9,
  "messages_deleted": 42
}
```

**Error Responses:**
```json
// 400 Bad Request - Invalid ID
{
  "error": "Invalid persona ID"
}

// 404 Not Found - Persona doesn't exist
{
  "error": "Persona not found"
}

// 500 Internal Server Error
{
  "error": "Failed to delete persona"
}
```

---

## 2. üí¨ Chat API

### 2.1 Chat (Non-streaming)
```
POST /api/chat
```

**Request:**
```json
{
  "message": "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ",
  "persona_id": 1,
  "session_id": "session_123",
  "use_history": true,
  "file_ids": ["uuid-1", "uuid-2"],
  "system_prompt": "You are helpful",
  "temperature": 0.7,
  "max_tokens": 2000
}
```

**Response:**
```json
{
  "message_id": "uuid",
  "session_id": "session_123",
  "reply": "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°?",
  "tokens_used": 50,
  "timestamp": "2025-11-04T10:30:00Z"
}
```

**Features:**
- ‚úÖ Conversation history support
- ‚úÖ File context integration (PDF, DOCX, TXT, Images)
- ‚úÖ Custom system prompts
- ‚úÖ Persona-based responses

---

### 2.2 Chat Streaming (WebSocket)
```
WS /api/chat/stream
```

**Auto-Detection:**
- Checks `OPENAI_API_KEY` ‚Üí Use OpenAI (GPT)
- If not available ‚Üí Use AWS Bedrock (Claude)

**Send Message:**
```json
{
  "type": "message",
  "content": "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ",
  "persona_id": 1,
  "session_id": "session_123",
  "file_ids": ["uuid"],
  "system_prompt": "You are helpful"
}
```

**Response (Streaming):**
```json
{"type":"chunk", "content":"‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ", "done":false}
{"type":"chunk", "content":"‡∏Ñ‡∏£‡∏±‡∏ö", "done":false}
{"type":"chunk", "content":"", "done":true, "message_id":"uuid", "tokens_used":50}
```

**Performance:**
- OpenAI: TTFB ~1-2s
- Bedrock: TTFB ~1-3s

---

### 2.3 Bedrock Chat (Claude)
```
POST /api/chat/bedrock
```

**Request:** Same as `/api/chat`

**Response:** Same format with `"provider": "bedrock"`

**Features:**
- ‚úÖ Claude Sonnet 4 model
- ‚úÖ Multimodal support (text + images)
- ‚úÖ File context integration
- ‚úÖ Conversation history

---

### 2.4 Get Chat History
```
GET /api/chats?limit=50&offset=0
```

**Response:**
```json
{
  "messages": [{
    "id": "uuid",
    "session_id": "session_123",
    "role": "user",
    "content": "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ",
    "persona_id": 1,
    "tokens_used": 10,
    "created_at": "2025-11-04T10:30:00Z"
  }],
  "total": 100,
  "limit": 50,
  "offset": 0
}
```

### 2.5 Get Chat History by Session
```
GET /api/chats/session/:sessionId?limit=50&offset=0
```

**Description:** Get all messages for a specific session ID with pagination support.

**URL Parameters:**
- `sessionId` (string, required) - Session ID to filter messages

**Query Parameters:**
- `limit` (integer, optional, default: 50, max: 100) - Number of messages per page
- `offset` (integer, optional, default: 0) - Number of messages to skip

**Response (200 OK):**
```json
{
  "messages": [{
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "role": "user",
    "content": "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö",
    "persona_id": 1,
    "created_at": "2025-11-05T10:30:00Z"
  }, {
    "id": "660e8400-e29b-41d4-a716-446655440001",
    "role": "assistant",
    "content": "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞ ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞",
    "persona_id": 1,
    "created_at": "2025-11-05T10:30:05Z"
  }],
  "total": 25,
  "limit": 50,
  "offset": 0
}
```

**Error Responses:**
```json
// 400 Bad Request - Missing session ID
{
  "error": "Session ID is required"
}

// 500 Internal Server Error
{
  "error": "Failed to retrieve chat history for session"
}
```

**Example Usage:**
```bash
# Get first 50 messages for session_123
curl http://localhost:3001/api/chats/session/session_123

# Get messages 10-20
curl "http://localhost:3001/api/chats/session/session_123?limit=10&offset=10"
```

**Features:**
- ‚úÖ Filter messages by session ID
- ‚úÖ Pagination support
- ‚úÖ Returns messages in chronological order
- ‚úÖ Includes all message metadata (persona_id, tokens_used, etc.)

### 2.6 Delete Messages by Session
```
DELETE /api/chats/session/:sessionId
```

**Description:** Delete all messages for a specific session ID.

**URL Parameters:**
- `sessionId` (string, required) - Session ID to delete messages from

**Response (200 OK):**
```json
{
  "message": "Session messages deleted successfully",
  "session_id": "session_123"
}
```

**Error Responses:**
```json
// 400 Bad Request - Missing session ID
{
  "error": "Session ID is required"
}

// 500 Internal Server Error
{
  "error": "Failed to delete messages for session"
}
```

**Example Usage:**
```bash
# Delete all messages from session_123
curl -X DELETE http://localhost:3001/api/chats/session/session_123
```

**Features:**
- ‚úÖ Delete all messages in a specific session
- ‚úÖ Clean up chat history for individual conversations
- ‚úÖ Does not affect other sessions

**Note:** This operation is irreversible. Deleted messages cannot be recovered.

---

### 2.7 Delete All Messages
```
DELETE /api/chats
```

**Description:** Delete ALL messages from the database (across all sessions).

**Response (200 OK):**
```json
{
  "message": "All messages deleted successfully"
}
```

**Error Responses:**
```json
// 500 Internal Server Error
{
  "error": "Failed to delete messages"
}
```

**Warning:** This deletes ALL messages from ALL sessions. Use with caution!

---

## 3. üìÅ File Upload API

### Upload Files
```
POST /api/file/uploads
```

**Form Data:**
- `files` - Multiple files (max 5)
- `prompt` - Analysis prompt (optional)
- `session_id` - Session ID (optional)
- `use_history` - Include history (optional)
- `system_prompt` - Custom prompt (optional)

**Supported Types:**
- **Text:** TXT, MD, JSON, CSV, XML (max 10 MB)
- **Documents:** PDF, DOCX, XLSX (max 25 MB)
- **Images:** JPG, PNG, GIF, WebP (max 20 MB)
- **Code:** JS, PY, GO, Java, etc. (max 5 MB)

**Response:**
```json
{
  "success": 2,
  "failed": 0,
  "total": 2,
  "uploaded_files": [{
    "file_id": "uuid",
    "file_name": "document.pdf",
    "file_size": 1024000,
    "mime_type": "application/pdf"
  }]
}
```

### Get File History
```
GET /api/file/history?limit=50&offset=0&file_type=application/pdf
```

### Delete All Files
```
DELETE /api/file/uploads
```

---

## 4. üé§ Audio API

### 4.1 Transcribe Audio (Whisper.cpp - Local)
```
POST /api/stt/whispercpp
```

**Description:** Transcribe audio using local Whisper.cpp engine (no API costs, runs locally).

**Form Data:**
- `audio` - Audio file (max 25 MB)
- `language` - Language code: "th", "en", "auto" (default: "th")
- `timestamps` - Boolean: return segments with timestamps (default: false)
- `model` - Model name: "tiny.en", "small", "medium", "large-v2" (optional, default: "small")

**Supported Audio Formats:** wav, mp3, m4a, ogg, webm

**Response (without timestamps):**
```json
{
  "success": true,
  "transcription": "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö",
  "confidence": 0.95,
  "language": "th",
  "model": "small"
}
```

**Response (with timestamps):**
```json
{
  "success": true,
  "transcription": "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö",
  "segments": [
    {
      "start": 0.0,
      "end": 1.5,
      "text": "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö"
    },
    {
      "start": 1.5,
      "end": 3.0,
      "text": "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö"
    }
  ],
  "language": "th",
  "duration": 3.0,
  "model": "small"
}
```

**Available Models:**
- `tiny.en` - Fastest, English only, low accuracy (~75 MB)
- `small` - Default, balanced speed and accuracy (~466 MB) ‚úÖ Recommended
- `medium` - Higher accuracy, slower (~1.5 GB)
- `large-v2` - Highest accuracy, slowest (~3 GB)

**Model Filename Formats Supported:**
- Standard: `ggml-{modelName}.bin` (e.g., `ggml-small.bin`)
- Quantized: `ggml-{modelName}-q5_1.bin` (e.g., `ggml-tiny-en-q5_1.bin`)

**Example Usage:**
```bash
# Basic transcription (Thai, default model)
curl -X POST http://localhost:3000/api/stt/whispercpp \
  -F "audio=@recording.wav" \
  -F "language=th"

# English transcription with timestamps using tiny.en model
curl -X POST http://localhost:3000/api/stt/whispercpp \
  -F "audio=@english_audio.mp3" \
  -F "language=en" \
  -F "timestamps=true" \
  -F "model=tiny.en"

# Auto-detect language with medium model
curl -X POST http://localhost:3000/api/stt/whispercpp \
  -F "audio=@mixed_audio.wav" \
  -F "language=auto" \
  -F "model=medium"
```

**Error Responses:**
```json
// 400 Bad Request - Invalid language
{
  "success": false,
  "error": "invalid language: fr (supported: th, en, auto)"
}

// 400 Bad Request - Unsupported format
{
  "success": false,
  "error": "unsupported audio format: avi (supported: wav, mp3, m4a, ogg, webm)"
}

// 413 Payload Too Large
{
  "success": false,
  "error": "file size exceeds maximum allowed (25MB)"
}

// 500 Internal Server Error - Model not found
{
  "success": false,
  "error": "failed to transcribe audio",
  "details": "model file not found: tried ggml-large-v3.bin and ggml-large-v3-q5_1.bin"
}
```

**Features:**
- ‚úÖ No API costs (runs completely local)
- ‚úÖ Privacy-friendly (audio never leaves your server)
- ‚úÖ Dynamic model selection
- ‚úÖ Multi-language support (Thai, English, auto-detect)
- ‚úÖ Timestamp support for subtitles/transcripts
- ‚úÖ Flexible model filename conventions
- ‚úÖ WSL2 support on Windows
- ‚úÖ Cross-platform (Linux, Windows with WSL, macOS)

---

### 4.2 Get Whisper.cpp Status
```
GET /api/stt/whispercpp/status
```

**Description:** Check Whisper.cpp service availability and capabilities.

**Response:**
```json
{
  "service": "whisper.cpp",
  "available": true,
  "supported_formats": ["wav", "mp3", "m4a", "ogg", "webm"],
  "supported_languages": ["th", "en", "auto"],
  "supported_models": ["tiny.en", "small", "medium", "large-v2"],
  "default_language": "auto",
  "default_model": "small",
  "current_os": "windows"
}
```

**Use Cases:**
- Check if Whisper.cpp binary is available
- Get list of supported models before transcription
- Validate audio format before upload
- UI model selector configuration

---

### 4.3 Transcribe Audio (OpenAI Whisper API)
```
POST /api/audio/transcribe
```

**Form Data:**
- `file` - Audio file (max 25 MB)

**Supported Formats:** MP3, MP4, WAV, M4A, WebM

**Response:**
```json
{
  "text": "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö",
  "language": "th",
  "duration": 3.5
}
```

**Note:** This endpoint uses OpenAI Whisper API (requires API key and incurs costs).

---

### Text-to-Speech (OpenAI)
```
POST /api/audio/tts
```

**Request:**
```json
{
  "text": "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö",
  "voice": "nova",
  "model": "tts-1",
  "response_format": "mp3",
  "speed": 1.0
}
```

**Voices:** alloy, echo, fable, onyx, nova, shimmer
**Models:** tts-1, tts-1-hd
**Formats:** mp3, opus, aac, flac, wav, pcm
**Speed:** 0.25-4.0

**Response:** Audio file (binary) or JSON with base64-encoded audio

---

### Text-to-Speech (ElevenLabs)
```
POST /audio/elevenlabs/tts
```

**Request:**
```json
{
  "text": "Hello, <break time=\"1s\"/> this is a test with <emphasis level=\"strong\">SSML support</emphasis>.",
  "voice_id": "21m00Tcm4TlvDq8ikWAM",
  "model_id": "eleven_multilingual_v2",
  "stability": 0.5,
  "similarity_boost": 0.75,
  "style": 0.0,
  "speed": 1.0,
  "use_speaker_boost": true
}
```

**Alternative Request (with voice_settings object):**
```json
{
  "text": "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö",
  "voice_id": "21m00Tcm4TlvDq8ikWAM",
  "model_id": "eleven_multilingual_v2",
  "voice_settings": {
    "stability": 0.5,
    "similarity_boost": 0.75,
    "style": 0.0,
    "speed": 1.0,
    "use_speaker_boost": true
  }
}
```

**Parameters:**
- `text` (required) - Text to convert to speech (supports SSML tags)
- `voice_id` (optional) - ElevenLabs voice ID (default: "21m00Tcm4TlvDq8ikWAM" - Rachel)
- `model_id` (optional) - Model to use (default: "eleven_multilingual_v2")
- `stability` (optional, 0.0-1.0) - Controls emotional consistency and accent stability
  - Low (0.0): More varied emotions and natural expression
  - High (1.0): More consistent, limited emotional range
- `similarity_boost` (optional, 0.0-1.0) - How closely AI matches original voice (for cloned voices)
  - High (1.0): Closer match to original voice
- `style` (optional, 0.0-1.0) - Exaggeration of speaking style
  - High: More pronounced style characteristics
- `speed` (optional, 0.7-1.2) - Speaking speed (1.0 = normal)
- `use_speaker_boost` (optional, boolean) - Enhance speaker characteristics

**SSML Support:**
ElevenLabs supports SSML (Speech Synthesis Markup Language) tags:
- `<break time="1s"/>` - Pause for specified duration
- `<emphasis level="strong">text</emphasis>` - Emphasize words
- Phonemes for specific pronunciation control

**Response (JSON with Accept: application/json):**
```json
{
  "audio_data": "base64-encoded-audio-data",
  "format": "mp3",
  "characters_used": 42,
  "model_id": "eleven_multilingual_v2",
  "voice_id": "21m00Tcm4TlvDq8ikWAM",
  "duration_seconds": 3.5,
  "timestamp": "2025-11-05T10:30:00Z"
}
```

**Response (Binary with Accept: audio/mpeg or audio/*):**
Returns raw MP3 audio data with headers:
- `Content-Type: audio/mpeg`
- `X-Audio-Duration: <seconds>`
- `X-Characters-Used: <count>`
- `X-Voice-ID: <voice_id>`
- `X-Model-ID: <model_id>`

**Available Models:**
- `eleven_multilingual_v2` - Multilingual, high quality
- `eleven_monolingual_v1` - English only, optimized
- `eleven_turbo_v2` - Fast generation, lower latency

---

### Get ElevenLabs Voices
```
GET /audio/elevenlabs/voices
```

**Response:**
```json
{
  "voices": [
    {
      "voice_id": "21m00Tcm4TlvDq8ikWAM",
      "name": "Rachel",
      "category": "premade",
      "labels": {
        "accent": "american",
        "description": "calm",
        "age": "young",
        "gender": "female"
      }
    }
  ],
  "count": 1
}
```

---

## üîê Environment Variables

```env
# Server
PORT=3001
APP_ENV=development

# Database
DATABASE_URL=postgres://user:pass@localhost:5432/chatbot_db

# CORS
CORS_ORIGIN=http://localhost:5173,http://localhost:5174

# OpenAI (Optional)
OPENAI_API_KEY=sk-...
OPENAI_MODEL=gpt-4o-mini
OPENAI_MAX_TOKENS=2000
OPENAI_TEMPERATURE=0.7

# AWS Bedrock (Optional)
AWS_ACCESS_KEY_ID=AKIA...
AWS_SECRET_ACCESS_KEY=...
AWS_REGION=ap-southeast-1
BEDROCK_MODEL_ID=apac.anthropic.claude-sonnet-4-20250514-v1:0
BEDROCK_MAX_TOKENS=2000
BEDROCK_TEMPERATURE=0.7

# ElevenLabs (Optional)
ELEVENLABS_API_KEY=...

# Whisper.cpp Speech-to-Text (Local)
WHISPER_BINARY_PATH_LINUX=./whisper/binary/linux/main
WHISPER_BINARY_PATH_WINDOWS=wsl /mnt/c/Users/.../backend/whisper/binary/linux/main
WHISPER_BINARY_PATH_MACOS=./whisper/binary/macos/main
WHISPER_MODEL_PATH=./whisper/models/ggml-small.bin
WHISPER_MODELS_DIR=./whisper/models
WHISPER_TEMP_DIR=./whisper/temp
WHISPER_LANGUAGE=auto
WHISPER_MODEL_NAME=small
WHISPER_SUPPORTED_MODELS=tiny.en,small,medium,large-v2
WHISPER_THREADS=4
WHISPER_PROCESSORS=1
WHISPER_BEAM_SIZE=5
WHISPER_BEST_OF=5

# Provider Selection
AI_PROVIDER=bedrock  # or "openai"
```

**Provider Priority:**
- WebSocket: Auto-detect based on `OPENAI_API_KEY`
- REST API: Use `AI_PROVIDER` variable

---

## üìä Database Models

### Persona
```go
ID              int       // Primary key
Name            string    // Unique name
SystemPrompt    string    // AI instructions
Tone            string    // friendly/professional/empathetic
Style           string    // concise/detailed/conversational
Temperature     float32   // 0.0-2.0
MaxTokens       int       // Response limit
Model           string    // AI model name
Icon            string    // Emoji
IsActive        bool      // Enabled?
```

### Message
```go
ID              uuid.UUID      // Primary key
SessionID       string         // Group conversations
Role            string         // user/assistant/system
Content         string         // Message text
PersonaID       *int           // FK to Persona
TokensUsed      *int           // Token count
FileAttachments JSONB          // Array of files
CreatedAt       time.Time
```

### FileAnalysis
```go
ID          uuid.UUID   // Primary key
FileName    string      // Original name
StoragePath string      // Disk location
MimeType    string      // Content type
FileSize    int64       // Bytes
UploadedAt  time.Time
DeletedAt   *time.Time  // Soft delete
```

---

## üõ°Ô∏è Security Issues (CRITICAL)

### ‚ö†Ô∏è MUST FIX BEFORE PRODUCTION

1. **Exposed Credentials** üî¥ CRITICAL
   - AWS credentials in `.env.development`
   - OpenAI API key in comments
   - **Action:** Rotate immediately, use secrets manager

2. **No Authentication** üî¥ CRITICAL
   - All endpoints are public
   - **Action:** Implement JWT or API key auth

3. **No Rate Limiting** üî¥ HIGH
   - Config exists but not implemented
   - **Action:** Add Fiber limiter middleware

4. **File Upload Risks** üü° MEDIUM
   - Path traversal possible with malicious filenames
   - **Action:** Sanitize filenames properly

5. **No Authorization** üî¥ CRITICAL
   - Anyone can delete all data
   - **Action:** Add permission checks

6. **Weak Error Messages** üü° MEDIUM
   - Exposes system internals
   - **Action:** Generic errors in production

7. **No Input Validation** üü° MEDIUM
   - Message length unlimited
   - **Action:** Add max length validators

8. **File Cleanup Missing** üü° MEDIUM
   - Deleted DB records don't remove disk files
   - **Action:** Delete files on record deletion

---

## üîß File Processing Features

### Text Extraction
- **PDF:** First 50 pages, plain text extraction
- **DOCX:** Full document text
- **XLSX:** All sheets, cell values
- **JSON/XML:** Formatted output
- **Code:** Syntax preserved

### Image Analysis
- Vision API integration (OpenAI)
- Multimodal support (Claude)
- Base64 encoding for API calls

### Size Limits
- Text files: 1 MB
- Documents: 5 MB
- Images: 20 MB (upload), processed via Vision API

---

## üåê WebSocket Implementation

### Connection Flow
1. Client connects: `ws://localhost:3001/api/chat/stream`
2. Send message with persona/session/files
3. Receive chunks as they're generated
4. Connection closed when done

### Message Format
```javascript
// Send
ws.send(JSON.stringify({
  type: "message",
  content: "Hello",
  persona_id: 1,
  session_id: "session_1",
  file_ids: ["uuid"]
}))

// Receive
ws.onmessage = (event) => {
  const data = JSON.parse(event.data)
  if (data.type === "chunk" && !data.done) {
    // Append chunk to UI
    appendText(data.content)
  } else if (data.done) {
    // Streaming complete
    console.log("Tokens used:", data.tokens_used)
  }
}
```

### Error Handling
```json
{
  "type": "error",
  "error": "Error message"
}
```

---

## üêõ Error Response Format

```json
{
  "error": "Error description"
}
```

**Status Codes:**
- `200` - Success
- `400` - Bad Request (validation error)
- `404` - Not Found
- `500` - Internal Server Error
- `429` - Too Many Requests (if rate limit implemented)

---

## üìå Version History

### v6.7 (2025-11-10) - Whisper.cpp Dynamic Model Selection
‚úÖ Enhanced Whisper.cpp with dynamic model selection
‚úÖ Added `model` parameter to POST /api/stt/whispercpp
‚úÖ Support for multiple models: tiny.en, small, medium, large-v2
‚úÖ Flexible model filename conventions (standard & quantized formats)
‚úÖ Updated GET /api/stt/whispercpp/status with supported models list
‚úÖ Model validation and error handling
‚úÖ Backward compatibility with default model

### v6.6 (2025-11-05) - Delete Messages by Session
‚úÖ DELETE /api/chats/session/:sessionId - Delete messages for specific session
‚úÖ Clean up individual chat history without affecting other sessions
‚úÖ Proper error handling and validation

### v6.5 (2025-11-05) - Chat History by Session
‚úÖ GET /api/chats/session/:sessionId - Get messages filtered by session ID
‚úÖ Pagination support for session-specific messages
‚úÖ Returns messages in chronological order
‚úÖ Includes full message metadata (persona_id, tokens_used, created_at)

### v6.4 (2025-11-05) - ElevenLabs TTS Integration
‚úÖ POST /audio/elevenlabs/tts - Text-to-Speech with ElevenLabs
‚úÖ GET /audio/elevenlabs/voices - Get available ElevenLabs voices
‚úÖ SSML support for advanced speech control
‚úÖ Voice settings: stability, similarity_boost, style, speed
‚úÖ Dual response format: JSON (base64) or binary audio
‚úÖ Multilingual support with multiple models

### v6.3 (2025-11-04) - Update Persona API
‚úÖ PATCH /api/persona/:id - Update persona (partial update support)
‚úÖ All fields optional in update request
‚úÖ Full validation on all fields

### v6.2 (2025-11-04) - Persona Management API
‚úÖ POST /api/persona - Create custom personas
‚úÖ DELETE /api/persona/:id - Delete personas by ID (cascade delete messages)
‚úÖ Full persona configuration support
‚úÖ Language settings and guardrails
‚úÖ Auto-generated persona IDs
‚úÖ Extended field limits (tone: 200, style: 500, expertise: 500)

### v6.1 (2025-11-04) - WebSocket File Support
‚úÖ Bedrock WebSocket now reads file content (PDF, DOCX, Images)
‚úÖ Multimodal support for images in streaming
‚úÖ Improved file context building

### v6.0 (2025-11-04) - AWS Bedrock Streaming
‚úÖ WebSocket streaming for Bedrock
‚úÖ Unified streaming interface (OpenAI + Bedrock)
‚úÖ Auto-detection of AI provider

### v5.1 (2025-11-04) - System Prompt Fix
‚úÖ Custom system_prompt appends to persona (doesn't replace)

### v5.0 (2025-11-04) - File Reading
‚úÖ PDF, DOCX, Images support
‚úÖ Vision API integration

### v4.0 (2025-11-03) - Enhanced Personas
‚úÖ 8 personas with full configuration

---

## üéØ Summary

**ChatBot API Features:**
- ‚úÖ Dual AI Providers (OpenAI GPT + AWS Bedrock Claude)
- ‚úÖ WebSocket Streaming (real-time responses)
- ‚úÖ 8 Pre-configured Personas + Custom Persona Creation
- ‚úÖ File Analysis (Text, PDF, DOCX, Images)
- ‚úÖ Speech-to-Text (Local Whisper.cpp + OpenAI Whisper API)
- ‚úÖ Dynamic Model Selection for Whisper.cpp (tiny.en, small, medium, large-v2)
- ‚úÖ Text-to-Speech (OpenAI TTS + ElevenLabs)
- ‚úÖ SSML Support for Advanced Speech Control
- ‚úÖ Conversation History
- ‚úÖ Session Management
- ‚úÖ Multimodal Support (text + images)
- ‚úÖ Dynamic Persona Management (Create, Read, Update, Delete)

**Architecture Highlights:**
- Clean layered architecture
- Repository pattern for data access
- Service layer for business logic
- WebSocket + REST API
- PostgreSQL with GORM ORM
- Fiber web framework

**Status:** ‚ö†Ô∏è **NOT Production Ready**
**Reason:** Critical security issues (no auth, exposed credentials, no rate limiting)

---

## üöÄ Next Steps (Priority Order)

### CRITICAL (Do First)
1. Remove exposed credentials from repo
2. Rotate all API keys (AWS, OpenAI)
3. Implement authentication (JWT)
4. Add rate limiting middleware
5. Add authorization checks

### HIGH PRIORITY
1. Add input validation middleware
2. Implement proper error handling
3. Add audit logging
4. Implement file cleanup on deletion
5. Add request ID tracking

### MEDIUM PRIORITY
1. Add API documentation (Swagger)
2. Implement caching strategy
3. Add monitoring/metrics
4. Implement soft deletes for messages
5. Add comprehensive tests

### NICE TO HAVE
1. API versioning
2. Role-based access control (RBAC)
3. WebSocket authentication
4. Message encryption
5. Backup/restore functionality

---

## üìñ Additional Resources

- **Go Fiber Docs:** https://docs.gofiber.io/
- **GORM Docs:** https://gorm.io/docs/
- **OpenAI API:** https://platform.openai.com/docs/
- **AWS Bedrock:** https://docs.aws.amazon.com/bedrock/
- **PostgreSQL:** https://www.postgresql.org/docs/

---

**End of Documentation**
