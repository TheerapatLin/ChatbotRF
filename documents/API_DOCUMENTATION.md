# ChatBot API Documentation

**Version:** 6.2 (2025-11-04)
**Base URL:** `http://localhost:3001`

---

## ğŸš€ Quick Start

```bash
# 1. Setup PostgreSQL
docker-compose up -d

# 2. Configure environment
cp backend/.env.development backend/.env
# Edit .env with your API keys

# 3. Install dependencies
cd backend && go mod download

# 4. Run server
go run main.go  # or use 'air' for hot reload
```

---

## ğŸ“‹ Architecture

**Pattern:** Repository-Service-Controller

```
Client Request
    â†“
Routes (routes.go)
    â†“
Controllers (business logic entry)
    â†“
Services (external API calls, business logic)
    â†“
Repositories (database operations)
    â†“
Database (PostgreSQL)
```

**Tech Stack:**
- **Framework:** Go Fiber v2
- **ORM:** GORM
- **Database:** PostgreSQL 15
- **AI Providers:** OpenAI GPT-4, AWS Bedrock Claude Sonnet 4
- **WebSocket:** Fiber WebSocket adapter
- **File Processing:** PDF/DOCX/XLSX extraction libraries

---

## ğŸ“š API Endpoints

### Health Check
```
GET /api/health
```

---

## 1. ğŸ¤– Personas API

**Personas** = AI personalities with different configurations (tone, expertise, model)

### List All Personas
```
GET /api/personas
```

**Response:**
```json
{
  "personas": [{
    "id": 1,
    "name": "General Assistant",
    "description": "à¸œà¸¹à¹‰à¸Šà¹ˆà¸§à¸¢à¸­à¹€à¸™à¸à¸›à¸£à¸°à¸ªà¸‡à¸„à¹Œ",
    "tone": "friendly",
    "style": "conversational",
    "expertise": "general",
    "temperature": 0.7,
    "max_tokens": 2000,
    "model": "gpt-4o-mini",
    "icon": "ğŸ¤–"
  }]
}
```

### Get Persona by ID
```
GET /api/personas/:id
```

**Response:** Same as above + usage statistics

---

### Create New Persona
```
POST /api/personas
```

**Request:**
```json
{
  "name": "Marketing Expert",
  "description": "AI à¸œà¸¹à¹‰à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¸”à¹‰à¸²à¸™à¸à¸²à¸£à¸•à¸¥à¸²à¸”",
  "system_prompt": "You are a marketing expert...",
  "tone": "professional",
  "style": "detailed",
  "expertise": "marketing",
  "temperature": 0.6,
  "max_tokens": 2500,
  "model": "gpt-4o-mini",
  "language_setting": {
    "default_language": "th",
    "response_style": "formal",
    "language_code": "th-TH"
  },
  "guardrails": {
    "block_profanity": true,
    "block_sensitive": false,
    "allowed_topics": ["marketing", "business", "advertising"],
    "blocked_topics": ["politics", "religion"],
    "max_response_length": 3000,
    "require_moderation": false
  },
  "icon": "ğŸ“ˆ"
}
```

**Response (201 Created):**
```json
{
  "id": 9,
  "name": "Marketing Expert",
  "description": "AI à¸œà¸¹à¹‰à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¸”à¹‰à¸²à¸™à¸à¸²à¸£à¸•à¸¥à¸²à¸”",
  "tone": "professional",
  "style": "detailed",
  "expertise": "marketing",
  "temperature": 0.6,
  "max_tokens": 2500,
  "model": "gpt-4o-mini",
  "language_setting": "{\"default_language\":\"th\",\"response_style\":\"formal\",\"language_code\":\"th-TH\"}",
  "guardrails": "{\"block_profanity\":true,\"block_sensitive\":false,\"allowed_topics\":[\"marketing\",\"business\",\"advertising\"],\"blocked_topics\":[\"politics\",\"religion\"],\"max_response_length\":3000,\"require_moderation\":false}",
  "icon": "ğŸ“ˆ",
  "is_active": true
}
```

**Field Details:**
- `name` (required, max 100 chars) - Persona name
- `description` (required) - Description
- `system_prompt` (required) - AI instructions
- `tone` (max 200 chars) - friendly/professional/empathetic (default: friendly)
- `style` (max 500 chars) - conversational/detailed/concise (default: conversational)
- `expertise` (max 500 chars) - general/technology/marketing/etc (default: general)
- `temperature` (0.0-2.0) - AI creativity level (default: 0.7)
- `max_tokens` - Response limit (default: 2000)
- `model` - AI model (default: gpt-4o-mini)
- `language_setting` - Language preferences (JSON object)
- `guardrails` - Content filters and rules (JSON object)
- `icon` (max 10 chars) - Emoji (default: ğŸ¤–)

**Valid Models:**
- OpenAI: `gpt-4o-mini`, `gpt-4o`, `gpt-4`, `gpt-3.5-turbo`
- Claude: `claude-sonnet-4`, `claude-3-opus`, `claude-3-sonnet`
- AWS Bedrock: `apac.anthropic.claude-sonnet-4-20250514-v1:0`

**Validation Rules:**
- Required fields must not be empty
- Field length limits must be respected
- Model name must be from valid models list
- Temperature must be between 0.0 and 2.0

**Note:** ID is auto-generated by database

**Error Responses:**
```json
{
  "error": "Invalid model name",
  "valid_models": ["gpt-4o-mini", "gpt-4o", "gpt-4", "gpt-3.5-turbo", "claude-sonnet-4", "claude-3-opus", "claude-3-sonnet"],
  "received": "invalid-model"
}
```

---

### Update Persona
```
PATCH /api/persona/:id
```

**URL Parameters:**
- `id` (integer) - Persona ID to update

**Request Body (Partial Update):**
All fields are optional - only send fields you want to update
```json
{
  "name": "Marketing Expert Pro",
  "description": "à¸œà¸¹à¹‰à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¸”à¹‰à¸²à¸™à¸à¸²à¸£à¸•à¸¥à¸²à¸”à¸”à¸´à¸ˆà¸´à¸—à¸±à¸¥ (à¸­à¸±à¸à¹€à¸”à¸•)",
  "system_prompt": "You are an advanced marketing expert...",
  "tone": "professional",
  "style": "analytical",
  "expertise": "digital marketing, SEO, content strategy",
  "temperature": 0.8,
  "max_tokens": 3000,
  "model": "gpt-4o",
  "icon": "ğŸ“Š",
  "is_active": true,
  "language_setting": {
    "default_language": "en",
    "response_style": "formal",
    "language_code": "en-US"
  },
  "guardrails": {
    "block_profanity": false,
    "block_sensitive": true,
    "allowed_topics": ["marketing", "business", "analytics"],
    "blocked_topics": [],
    "max_response_length": 5000,
    "require_moderation": false
  }
}
```

**Response (200 OK):**
```json
{
  "id": 9,
  "name": "Marketing Expert Pro",
  "description": "à¸œà¸¹à¹‰à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¸”à¹‰à¸²à¸™à¸à¸²à¸£à¸•à¸¥à¸²à¸”à¸”à¸´à¸ˆà¸´à¸—à¸±à¸¥ (à¸­à¸±à¸à¹€à¸”à¸•)",
  "tone": "professional",
  "style": "analytical",
  "expertise": "digital marketing, SEO, content strategy",
  "temperature": 0.8,
  "max_tokens": 3000,
  "model": "gpt-4o",
  "language_setting": "{\"default_language\":\"en\",\"response_style\":\"formal\",\"language_code\":\"en-US\"}",
  "guardrails": "{\"block_profanity\":false,\"block_sensitive\":true,...}",
  "icon": "ğŸ“Š",
  "is_active": true
}
```

**Validation Rules:**
- Same as Create Persona endpoint
- Name: max 100 chars (cannot be empty if provided)
- Tone: max 200 chars
- Style: max 500 chars
- Expertise: max 500 chars
- Temperature: 0.0-2.0
- Model: must be valid model name
- Icon: max 10 chars
- System prompt: cannot be empty if provided

**Error Responses:**
```json
// 400 Bad Request - Invalid ID
{
  "error": "Invalid persona ID"
}

// 404 Not Found - Persona doesn't exist
{
  "error": "Persona not found"
}

// 400 Bad Request - Validation error
{
  "error": "Temperature must be between 0.0 and 2.0"
}

// 500 Internal Server Error
{
  "error": "Failed to update persona"
}
```

---

### Delete Persona
```
DELETE /api/persona/:id
```

**URL Parameters:**
- `id` (integer) - Persona ID to delete

**Behavior:**
- Deletes all messages associated with the persona first (cascade delete)
- Then deletes the persona itself
- Returns count of deleted messages

**Response (200 OK):**
```json
{
  "message": "Persona deleted successfully",
  "id": 9,
  "messages_deleted": 42
}
```

**Error Responses:**
```json
// 400 Bad Request - Invalid ID
{
  "error": "Invalid persona ID"
}

// 404 Not Found - Persona doesn't exist
{
  "error": "Persona not found"
}

// 500 Internal Server Error
{
  "error": "Failed to delete persona"
}
```

---

## 2. ğŸ’¬ Chat API

### 2.1 Chat (Non-streaming)
```
POST /api/chat
```

**Request:**
```json
{
  "message": "à¸ªà¸§à¸±à¸ªà¸”à¸µ",
  "persona_id": 1,
  "session_id": "session_123",
  "use_history": true,
  "file_ids": ["uuid-1", "uuid-2"],
  "system_prompt": "You are helpful",
  "temperature": 0.7,
  "max_tokens": 2000
}
```

**Response:**
```json
{
  "message_id": "uuid",
  "session_id": "session_123",
  "reply": "à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¸£à¸±à¸š! à¸¡à¸µà¸­à¸°à¹„à¸£à¹ƒà¸«à¹‰à¸Šà¹ˆà¸§à¸¢à¹„à¸«à¸¡?",
  "tokens_used": 50,
  "timestamp": "2025-11-04T10:30:00Z"
}
```

**Features:**
- âœ… Conversation history support
- âœ… File context integration (PDF, DOCX, TXT, Images)
- âœ… Custom system prompts
- âœ… Persona-based responses

---

### 2.2 Chat Streaming (WebSocket)
```
WS /api/chat/stream
```

**Auto-Detection:**
- Checks `OPENAI_API_KEY` â†’ Use OpenAI (GPT)
- If not available â†’ Use AWS Bedrock (Claude)

**Send Message:**
```json
{
  "type": "message",
  "content": "à¸ªà¸§à¸±à¸ªà¸”à¸µ",
  "persona_id": 1,
  "session_id": "session_123",
  "file_ids": ["uuid"],
  "system_prompt": "You are helpful"
}
```

**Response (Streaming):**
```json
{"type":"chunk", "content":"à¸ªà¸§à¸±à¸ªà¸”à¸µ", "done":false}
{"type":"chunk", "content":"à¸„à¸£à¸±à¸š", "done":false}
{"type":"chunk", "content":"", "done":true, "message_id":"uuid", "tokens_used":50}
```

**Performance:**
- OpenAI: TTFB ~1-2s
- Bedrock: TTFB ~1-3s

---

### 2.3 Bedrock Chat (Claude)
```
POST /api/chat/bedrock
```

**Request:** Same as `/api/chat`

**Response:** Same format with `"provider": "bedrock"`

**Features:**
- âœ… Claude Sonnet 4 model
- âœ… Multimodal support (text + images)
- âœ… File context integration
- âœ… Conversation history

---

### 2.4 Get Chat History
```
GET /api/chats?limit=50&offset=0
```

**Response:**
```json
{
  "messages": [{
    "id": "uuid",
    "session_id": "session_123",
    "role": "user",
    "content": "à¸ªà¸§à¸±à¸ªà¸”à¸µ",
    "persona_id": 1,
    "tokens_used": 10,
    "created_at": "2025-11-04T10:30:00Z"
  }],
  "total": 100,
  "limit": 50,
  "offset": 0
}
```

### 2.5 Delete All Messages
```
DELETE /api/chats
```

---

## 3. ğŸ“ File Upload API

### Upload Files
```
POST /api/file/uploads
```

**Form Data:**
- `files` - Multiple files (max 5)
- `prompt` - Analysis prompt (optional)
- `session_id` - Session ID (optional)
- `use_history` - Include history (optional)
- `system_prompt` - Custom prompt (optional)

**Supported Types:**
- **Text:** TXT, MD, JSON, CSV, XML (max 10 MB)
- **Documents:** PDF, DOCX, XLSX (max 25 MB)
- **Images:** JPG, PNG, GIF, WebP (max 20 MB)
- **Code:** JS, PY, GO, Java, etc. (max 5 MB)

**Response:**
```json
{
  "success": 2,
  "failed": 0,
  "total": 2,
  "uploaded_files": [{
    "file_id": "uuid",
    "file_name": "document.pdf",
    "file_size": 1024000,
    "mime_type": "application/pdf"
  }]
}
```

### Get File History
```
GET /api/file/history?limit=50&offset=0&file_type=application/pdf
```

### Delete All Files
```
DELETE /api/file/uploads
```

---

## 4. ğŸ¤ Audio API

### Transcribe Audio (Whisper)
```
POST /api/audio/transcribe
```

**Form Data:**
- `file` - Audio file (max 25 MB)

**Supported Formats:** MP3, MP4, WAV, M4A, WebM

**Response:**
```json
{
  "text": "à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¸£à¸±à¸š",
  "language": "th",
  "duration": 3.5
}
```

---

### Text-to-Speech
```
POST /api/audio/tts
```

**Request:**
```json
{
  "text": "à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¸£à¸±à¸š",
  "voice": "nova",
  "model": "tts-1",
  "response_format": "mp3",
  "speed": 1.0
}
```

**Voices:** alloy, echo, fable, onyx, nova, shimmer
**Models:** tts-1, tts-1-hd
**Formats:** mp3, opus, aac, flac, wav, pcm
**Speed:** 0.25-4.0

**Response:** Audio file (binary)

---

## ğŸ” Environment Variables

```env
# Server
PORT=3001
APP_ENV=development

# Database
DATABASE_URL=postgres://user:pass@localhost:5432/chatbot_db

# CORS
CORS_ORIGIN=http://localhost:5173,http://localhost:5174

# OpenAI (Optional)
OPENAI_API_KEY=sk-...
OPENAI_MODEL=gpt-4o-mini
OPENAI_MAX_TOKENS=2000
OPENAI_TEMPERATURE=0.7

# AWS Bedrock (Optional)
AWS_ACCESS_KEY_ID=AKIA...
AWS_SECRET_ACCESS_KEY=...
AWS_REGION=ap-southeast-1
BEDROCK_MODEL_ID=apac.anthropic.claude-sonnet-4-20250514-v1:0
BEDROCK_MAX_TOKENS=2000
BEDROCK_TEMPERATURE=0.7

# Provider Selection
AI_PROVIDER=bedrock  # or "openai"
```

**Provider Priority:**
- WebSocket: Auto-detect based on `OPENAI_API_KEY`
- REST API: Use `AI_PROVIDER` variable

---

## ğŸ“Š Database Models

### Persona
```go
ID              int       // Primary key
Name            string    // Unique name
SystemPrompt    string    // AI instructions
Tone            string    // friendly/professional/empathetic
Style           string    // concise/detailed/conversational
Temperature     float32   // 0.0-2.0
MaxTokens       int       // Response limit
Model           string    // AI model name
Icon            string    // Emoji
IsActive        bool      // Enabled?
```

### Message
```go
ID              uuid.UUID      // Primary key
SessionID       string         // Group conversations
Role            string         // user/assistant/system
Content         string         // Message text
PersonaID       *int           // FK to Persona
TokensUsed      *int           // Token count
FileAttachments JSONB          // Array of files
CreatedAt       time.Time
```

### FileAnalysis
```go
ID          uuid.UUID   // Primary key
FileName    string      // Original name
StoragePath string      // Disk location
MimeType    string      // Content type
FileSize    int64       // Bytes
UploadedAt  time.Time
DeletedAt   *time.Time  // Soft delete
```

---

## ğŸ›¡ï¸ Security Issues (CRITICAL)

### âš ï¸ MUST FIX BEFORE PRODUCTION

1. **Exposed Credentials** ğŸ”´ CRITICAL
   - AWS credentials in `.env.development`
   - OpenAI API key in comments
   - **Action:** Rotate immediately, use secrets manager

2. **No Authentication** ğŸ”´ CRITICAL
   - All endpoints are public
   - **Action:** Implement JWT or API key auth

3. **No Rate Limiting** ğŸ”´ HIGH
   - Config exists but not implemented
   - **Action:** Add Fiber limiter middleware

4. **File Upload Risks** ğŸŸ¡ MEDIUM
   - Path traversal possible with malicious filenames
   - **Action:** Sanitize filenames properly

5. **No Authorization** ğŸ”´ CRITICAL
   - Anyone can delete all data
   - **Action:** Add permission checks

6. **Weak Error Messages** ğŸŸ¡ MEDIUM
   - Exposes system internals
   - **Action:** Generic errors in production

7. **No Input Validation** ğŸŸ¡ MEDIUM
   - Message length unlimited
   - **Action:** Add max length validators

8. **File Cleanup Missing** ğŸŸ¡ MEDIUM
   - Deleted DB records don't remove disk files
   - **Action:** Delete files on record deletion

---

## ğŸ”§ File Processing Features

### Text Extraction
- **PDF:** First 50 pages, plain text extraction
- **DOCX:** Full document text
- **XLSX:** All sheets, cell values
- **JSON/XML:** Formatted output
- **Code:** Syntax preserved

### Image Analysis
- Vision API integration (OpenAI)
- Multimodal support (Claude)
- Base64 encoding for API calls

### Size Limits
- Text files: 1 MB
- Documents: 5 MB
- Images: 20 MB (upload), processed via Vision API

---

## ğŸŒ WebSocket Implementation

### Connection Flow
1. Client connects: `ws://localhost:3001/api/chat/stream`
2. Send message with persona/session/files
3. Receive chunks as they're generated
4. Connection closed when done

### Message Format
```javascript
// Send
ws.send(JSON.stringify({
  type: "message",
  content: "Hello",
  persona_id: 1,
  session_id: "session_1",
  file_ids: ["uuid"]
}))

// Receive
ws.onmessage = (event) => {
  const data = JSON.parse(event.data)
  if (data.type === "chunk" && !data.done) {
    // Append chunk to UI
    appendText(data.content)
  } else if (data.done) {
    // Streaming complete
    console.log("Tokens used:", data.tokens_used)
  }
}
```

### Error Handling
```json
{
  "type": "error",
  "error": "Error message"
}
```

---

## ğŸ› Error Response Format

```json
{
  "error": "Error description"
}
```

**Status Codes:**
- `200` - Success
- `400` - Bad Request (validation error)
- `404` - Not Found
- `500` - Internal Server Error
- `429` - Too Many Requests (if rate limit implemented)

---

## ğŸ“Œ Version History

### v6.3 (2025-11-04) - Update Persona API
âœ… PATCH /api/persona/:id - Update persona (partial update support)
âœ… All fields optional in update request
âœ… Full validation on all fields

### v6.2 (2025-11-04) - Persona Management API
âœ… POST /api/persona - Create custom personas
âœ… DELETE /api/persona/:id - Delete personas by ID (cascade delete messages)
âœ… Full persona configuration support
âœ… Language settings and guardrails
âœ… Auto-generated persona IDs
âœ… Extended field limits (tone: 200, style: 500, expertise: 500)

### v6.1 (2025-11-04) - WebSocket File Support
âœ… Bedrock WebSocket now reads file content (PDF, DOCX, Images)
âœ… Multimodal support for images in streaming
âœ… Improved file context building

### v6.0 (2025-11-04) - AWS Bedrock Streaming
âœ… WebSocket streaming for Bedrock
âœ… Unified streaming interface (OpenAI + Bedrock)
âœ… Auto-detection of AI provider

### v5.1 (2025-11-04) - System Prompt Fix
âœ… Custom system_prompt appends to persona (doesn't replace)

### v5.0 (2025-11-04) - File Reading
âœ… PDF, DOCX, Images support
âœ… Vision API integration

### v4.0 (2025-11-03) - Enhanced Personas
âœ… 8 personas with full configuration

---

## ğŸ¯ Summary

**ChatBot API Features:**
- âœ… Dual AI Providers (OpenAI GPT + AWS Bedrock Claude)
- âœ… WebSocket Streaming (real-time responses)
- âœ… 8 Pre-configured Personas + Custom Persona Creation
- âœ… File Analysis (Text, PDF, DOCX, Images)
- âœ… Speech-to-Text & Text-to-Speech
- âœ… Conversation History
- âœ… Session Management
- âœ… Multimodal Support (text + images)
- âœ… Dynamic Persona Management (Create, Read)

**Architecture Highlights:**
- Clean layered architecture
- Repository pattern for data access
- Service layer for business logic
- WebSocket + REST API
- PostgreSQL with GORM ORM
- Fiber web framework

**Status:** âš ï¸ **NOT Production Ready**
**Reason:** Critical security issues (no auth, exposed credentials, no rate limiting)

---

## ğŸš€ Next Steps (Priority Order)

### CRITICAL (Do First)
1. Remove exposed credentials from repo
2. Rotate all API keys (AWS, OpenAI)
3. Implement authentication (JWT)
4. Add rate limiting middleware
5. Add authorization checks

### HIGH PRIORITY
1. Add input validation middleware
2. Implement proper error handling
3. Add audit logging
4. Implement file cleanup on deletion
5. Add request ID tracking

### MEDIUM PRIORITY
1. Add API documentation (Swagger)
2. Implement caching strategy
3. Add monitoring/metrics
4. Implement soft deletes for messages
5. Add comprehensive tests

### NICE TO HAVE
1. API versioning
2. Role-based access control (RBAC)
3. WebSocket authentication
4. Message encryption
5. Backup/restore functionality

---

## ğŸ“– Additional Resources

- **Go Fiber Docs:** https://docs.gofiber.io/
- **GORM Docs:** https://gorm.io/docs/
- **OpenAI API:** https://platform.openai.com/docs/
- **AWS Bedrock:** https://docs.aws.amazon.com/bedrock/
- **PostgreSQL:** https://www.postgresql.org/docs/

---

**End of Documentation**
