<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TTS WebSocket Test</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 40px;
      max-width: 600px;
      width: 100%;
    }

    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .status {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 20px;
    }

    .status.connected {
      background: #4caf50;
      color: white;
    }

    .status.disconnected {
      background: #f44336;
      color: white;
    }

    textarea {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      resize: vertical;
      margin-bottom: 20px;
      font-family: inherit;
    }

    textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .option-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 5px;
      color: #555;
    }

    select, input[type="range"] {
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
    }

    select:focus, input[type="range"]:focus {
      outline: none;
      border-color: #667eea;
    }

    .progress-bar {
      position: relative;
      height: 30px;
      background: #e0e0e0;
      border-radius: 8px;
      margin: 15px 0;
      overflow: hidden;
      display: none;
    }

    .progress-bar.active {
      display: block;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.3s ease;
    }

    .progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 12px;
      font-weight: bold;
      color: #333;
    }

    .controls {
      display: flex;
      gap: 10px;
    }

    button {
      flex: 1;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      font-family: inherit;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-danger {
      background: #f44336;
      color: white;
    }

    .btn-danger:hover:not(:disabled) {
      background: #d32f2f;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
    }

    .btn-warning {
      background: #ff9800;
      color: white;
    }

    .btn-warning:hover:not(:disabled) {
      background: #f57c00;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4);
    }

    .error-message {
      margin-top: 15px;
      padding: 15px;
      background: #ffebee;
      color: #c62828;
      border-radius: 8px;
      font-size: 14px;
      display: none;
    }

    .error-message.active {
      display: block;
    }

    .log {
      margin-top: 20px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 12px;
      font-family: 'Courier New', monospace;
    }

    .log-entry {
      margin-bottom: 5px;
      padding: 5px;
      border-radius: 4px;
    }

    .log-entry.info {
      background: #e3f2fd;
      color: #1976d2;
    }

    .log-entry.success {
      background: #e8f5e9;
      color: #388e3c;
    }

    .log-entry.error {
      background: #ffebee;
      color: #c62828;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîä TTS WebSocket Test</h1>
    <span id="status" class="status disconnected">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span>

    <textarea
      id="text"
      rows="4"
      placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á...">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏ö‡∏ö real-time</textarea>

    <div class="options">
      <div class="option-group">
        <label>‡πÄ‡∏™‡∏µ‡∏¢‡∏á</label>
        <select id="voice">
          <option value="alloy">Alloy (‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏≤‡∏á)</option>
          <option value="echo">Echo (‡∏ä‡∏≤‡∏¢)</option>
          <option value="fable">Fable (‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)</option>
          <option value="onyx">Onyx (‡∏ó‡∏∏‡πâ‡∏°)</option>
          <option value="nova" selected>Nova (‡∏´‡∏ç‡∏¥‡∏á)</option>
          <option value="shimmer">Shimmer (‡∏ô‡∏∏‡πà‡∏°)</option>
        </select>
      </div>

      <div class="option-group">
        <label>Model</label>
        <select id="model">
          <option value="gpt-4o-mini-tts" selected>GPT-4o Mini TTS (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)</option>
          <option value="tts-1">TTS-1 (Standard)</option>
          <option value="tts-1-hd">TTS-1 HD (High Quality)</option>
        </select>
      </div>

      <div class="option-group">
        <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß: <span id="speedValue">1.0</span></label>
        <input
          type="range"
          id="speed"
          min="0.25"
          max="4.0"
          step="0.25"
          value="1.0">
      </div>

      <div class="option-group">
        <label>‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå</label>
        <select id="emotion">
          <option value="neutral">‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option>
          <option value="happy">‡∏£‡πà‡∏≤‡πÄ‡∏£‡∏¥‡∏á</option>
          <option value="sad">‡πÄ‡∏®‡∏£‡πâ‡∏≤</option>
          <option value="excited">‡∏ï‡∏∑‡πà‡∏ô‡πÄ‡∏ï‡πâ‡∏ô</option>
          <option value="calm">‡∏™‡∏á‡∏ö</option>
          <option value="serious">‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏±‡∏á</option>
        </select>
      </div>

      <div class="option-group">
        <label>‡∏™‡πÑ‡∏ï‡∏•‡πå</label>
        <select id="style">
          <option value="formal">‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£</option>
          <option value="casual">‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£</option>
          <option value="empathetic">‡πÄ‡∏´‡πá‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏à</option>
        </select>
      </div>
    </div>

    <div id="progressBar" class="progress-bar">
      <div id="progressFill" class="progress-fill" style="width: 0%"></div>
      <span id="progressText" class="progress-text">0 / 0</span>
    </div>

    <div class="controls">
      <button id="speakBtn" class="btn-primary">üé§ ‡∏û‡∏π‡∏î</button>
      <button id="stopBtn" class="btn-danger" disabled>‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î</button>
      <button id="pauseBtn" class="btn-warning" disabled>‚è∏Ô∏è ‡∏û‡∏±‡∏Å</button>
    </div>

    <div id="errorMessage" class="error-message"></div>

    <div class="log" id="log"></div>
  </div>

  <script>
    // TTS WebSocket Service
    class TTSWebSocketService {
      constructor() {
        this.ws = null
        this.audioQueue = []
        this.isPlaying = false
        this.sessionId = null
        this.audioContext = null
        this.sourceNode = null

        this.onChunk = null
        this.onComplete = null
        this.onError = null
        this.onStopped = null
      }

      connect() {
        return new Promise((resolve, reject) => {
          const wsUrl = 'ws://localhost:3001/api'
          this.ws = new WebSocket(`${wsUrl}/ws/tts`)

          this.ws.onopen = () => {
            console.log('‚úÖ TTS WebSocket ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß')
            resolve()
          }

          this.ws.onerror = (error) => {
            console.error('‚ùå TTS WebSocket error:', error)
            reject(new Error('WebSocket connection failed'))
          }

          this.ws.onmessage = (event) => {
            this.handleMessage(JSON.parse(event.data))
          }

          this.ws.onclose = () => {
            console.log('TTS WebSocket ‡∏ï‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠')
            this.cleanup()
          }
        })
      }

      async synthesize(options) {
        const {
          text,
          model = 'gpt-4o-mini-tts',
          voice = 'nova',
          speed = 1.0,
          emotionRange = 'neutral',
          styleHint = 'casual'
        } = options

        this.sessionId = `tts_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
        this.stop()

        const message = {
          type: 'tts',
          session_id: this.sessionId,
          text,
          model,
          voice,
          speed,
          emotion_range: emotionRange,
          style_hint: styleHint
        }

        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
          this.ws.send(JSON.stringify(message))
        } else {
          throw new Error('WebSocket ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠')
        }
      }

      handleMessage(data) {
        switch (data.type) {
          case 'audio_chunk':
            this.handleAudioChunk(data)
            if (this.onChunk) this.onChunk(data)
            break
          case 'completed':
            this.handleComplete(data)
            if (this.onComplete) this.onComplete(data)
            break
          case 'error':
            console.error('TTS Error:', data.error)
            if (this.onError) this.onError(data.error)
            break
          case 'stopped':
            console.log('TTS ‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß')
            if (this.onStopped) this.onStopped()
            break
        }
      }

      handleAudioChunk(data) {
        const audioData = this.base64ToArrayBuffer(data.audio_data)
        this.audioQueue.push({
          data: audioData,
          format: data.format,
          index: data.chunk_index
        })

        if (!this.isPlaying) {
          this.playQueue()
        }
      }

      async playQueue() {
        if (this.audioQueue.length === 0) {
          this.isPlaying = false
          return
        }

        this.isPlaying = true
        const chunk = this.audioQueue.shift()

        try {
          if (!this.audioContext) {
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)()
          }

          const audioBuffer = await this.audioContext.decodeAudioData(chunk.data)
          this.sourceNode = this.audioContext.createBufferSource()
          this.sourceNode.buffer = audioBuffer
          this.sourceNode.connect(this.audioContext.destination)
          this.sourceNode.start(0)

          this.sourceNode.onended = () => {
            this.playQueue()
          }
        } catch (error) {
          console.error('Error playing audio chunk:', error)
          this.playQueue()
        }
      }

      stop() {
        if (this.ws && this.ws.readyState === WebSocket.OPEN && this.sessionId) {
          this.ws.send(JSON.stringify({
            type: 'stop',
            session_id: this.sessionId
          }))
        }

        if (this.sourceNode) {
          try {
            this.sourceNode.stop()
          } catch (e) {}
          this.sourceNode = null
        }

        this.audioQueue = []
        this.isPlaying = false
      }

      pause() {
        if (this.audioContext && this.audioContext.state === 'running') {
          this.audioContext.suspend()
        }
      }

      resume() {
        if (this.audioContext && this.audioContext.state === 'suspended') {
          this.audioContext.resume()
        }
      }

      handleComplete(data) {
        console.log('‚úÖ TTS ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå:', data)
      }

      cleanup() {
        this.stop()
        if (this.audioContext) {
          this.audioContext.close()
          this.audioContext = null
        }
      }

      disconnect() {
        this.cleanup()
        if (this.ws) {
          this.ws.close()
          this.ws = null
        }
      }

      base64ToArrayBuffer(base64) {
        const binaryString = window.atob(base64)
        const len = binaryString.length
        const bytes = new Uint8Array(len)

        for (let i = 0; i < len; i++) {
          bytes[i] = binaryString.charCodeAt(i)
        }

        return bytes.buffer
      }
    }

    /**
     * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö TTS
     * @param {string} emotion - ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
     * @param {string} style - ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
     * @returns {string} ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
     */
    function buildEmotionInstruction(emotion, style) {
      const emotionMap = {
        'neutral': '‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏≤‡∏á',
        'happy': '‡∏£‡πà‡∏≤‡πÄ‡∏£‡∏¥‡∏á ‡∏™‡∏ô‡∏∏‡∏Å‡∏™‡∏ô‡∏≤‡∏ô',
        'sad': '‡πÄ‡∏®‡∏£‡πâ‡∏≤ ‡πÄ‡∏™‡∏µ‡∏¢‡πÉ‡∏à',
        'excited': '‡∏ï‡∏∑‡πà‡∏ô‡πÄ‡∏ï‡πâ‡∏ô ‡∏Å‡∏£‡∏∞‡∏ï‡∏∑‡∏≠‡∏£‡∏∑‡∏≠‡∏£‡πâ‡∏ô',
        'calm': '‡∏™‡∏á‡∏ö ‡πÉ‡∏à‡πÄ‡∏¢‡πá‡∏ô',
        'serious': '‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏±‡∏á ‡πÄ‡∏Ñ‡∏£‡πà‡∏á‡∏Ç‡∏£‡∏∂‡∏°'
      }

      const styleMap = {
        'formal': '‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£',
        'casual': '‡∏™‡∏ö‡∏≤‡∏¢‡πÜ ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£',
        'empathetic': '‡πÄ‡∏´‡πá‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏à ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à'
      }

      const emotionText = emotionMap[emotion] || emotion
      const styleText = styleMap[style] || style

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
      if (emotion === 'neutral' && style === 'formal') {
        return '' // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô default
      }

      return `[‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà${emotionText} ‡πÅ‡∏ö‡∏ö${styleText}. Use ${emotion} tone with ${style} style]`
    }

    // UI Management
    const ttsService = new TTSWebSocketService()
    let isConnected = false
    let isPlaying = false
    let currentChunk = 0
    let totalChunks = 0

    const elements = {
      status: document.getElementById('status'),
      text: document.getElementById('text'),
      voice: document.getElementById('voice'),
      model: document.getElementById('model'),
      speed: document.getElementById('speed'),
      speedValue: document.getElementById('speedValue'),
      emotion: document.getElementById('emotion'),
      style: document.getElementById('style'),
      speakBtn: document.getElementById('speakBtn'),
      stopBtn: document.getElementById('stopBtn'),
      pauseBtn: document.getElementById('pauseBtn'),
      progressBar: document.getElementById('progressBar'),
      progressFill: document.getElementById('progressFill'),
      progressText: document.getElementById('progressText'),
      errorMessage: document.getElementById('errorMessage'),
      log: document.getElementById('log')
    }

    // Update speed value display
    elements.speed.addEventListener('input', (e) => {
      elements.speedValue.textContent = e.target.value
    })

    // Connect on page load
    async function initialize() {
      try {
        addLog('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket...', 'info')
        await ttsService.connect()
        isConnected = true
        elements.status.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß'
        elements.status.className = 'status connected'
        addLog('‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success')
      } catch (error) {
        isConnected = false
        elements.status.textContent = '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠'
        elements.status.className = 'status disconnected'
        showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket: ' + error.message)
        addLog('‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message, 'error')
      }
    }

    // Setup callbacks
    ttsService.onChunk = (data) => {
      isPlaying = true
      currentChunk = data.chunk_index + 1
      totalChunks = data.total_chunks || 0
      updateProgress()
      updateButtons()
      addLog(`üì¶ ‡∏£‡∏±‡∏ö chunk ${currentChunk}/${totalChunks}`, 'info')
    }

    ttsService.onComplete = (data) => {
      isPlaying = false
      elements.progressBar.classList.remove('active')
      updateButtons()
      addLog('‚úÖ ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå', 'success')
    }

    ttsService.onError = (error) => {
      isPlaying = false
      showError(error)
      updateButtons()
      addLog('‚ùå Error: ' + error, 'error')
    }

    ttsService.onStopped = () => {
      isPlaying = false
      elements.progressBar.classList.remove('active')
      updateButtons()
      addLog('‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß', 'info')
    }

    // Speak button
    elements.speakBtn.addEventListener('click', async () => {
      const text = elements.text.value.trim()
      if (!text) {
        showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°')
        return
      }

      if (!isConnected) {
        showError('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket')
        return
      }

      try {
        hideError()
        elements.progressBar.classList.add('active')
        currentChunk = 0
        totalChunks = 0
        updateProgress()

        // ‡∏£‡∏ß‡∏°‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        const emotion = elements.emotion.value
        const style = elements.style.value
        const emotionInstruction = buildEmotionInstruction(emotion, style)
        const finalText = emotionInstruction ? text + ' ' + emotionInstruction : text

        addLog(`üìù ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á: ${finalText}`, 'info')

        await ttsService.synthesize({
          text: finalText,                    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏° instruction ‡πÅ‡∏•‡πâ‡∏ß
          model: elements.model.value,        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á model
          voice: elements.voice.value,
          speed: parseFloat(elements.speed.value),
          emotionRange: emotion,              // ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠ voice mapping
          styleHint: style                    // ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠ voice mapping
        })

        isPlaying = true
        updateButtons()
        addLog('üé§ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πà‡∏á TTS request...', 'info')
      } catch (error) {
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message)
        addLog('‚ùå Error: ' + error.message, 'error')
      }
    })

    // Stop button
    elements.stopBtn.addEventListener('click', () => {
      ttsService.stop()
      addLog('üõë ‡∏Å‡∏î‡∏´‡∏¢‡∏∏‡∏î', 'info')
    })

    // Pause button
    elements.pauseBtn.addEventListener('click', () => {
      if (ttsService.audioContext && ttsService.audioContext.state === 'running') {
        ttsService.pause()
        elements.pauseBtn.textContent = '‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠'
        addLog('‚è∏Ô∏è ‡∏û‡∏±‡∏Å', 'info')
      } else {
        ttsService.resume()
        elements.pauseBtn.textContent = '‚è∏Ô∏è ‡∏û‡∏±‡∏Å'
        addLog('‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠', 'info')
      }
    })

    // Update progress bar
    function updateProgress() {
      if (totalChunks > 0) {
        const percent = (currentChunk / totalChunks) * 100
        elements.progressFill.style.width = percent + '%'
        elements.progressText.textContent = `${currentChunk} / ${totalChunks}`
      }
    }

    // Update button states
    function updateButtons() {
      elements.speakBtn.disabled = isPlaying
      elements.stopBtn.disabled = !isPlaying
      elements.pauseBtn.disabled = !isPlaying
    }

    // Show error message
    function showError(message) {
      elements.errorMessage.textContent = '‚ùå ' + message
      elements.errorMessage.classList.add('active')
    }

    // Hide error message
    function hideError() {
      elements.errorMessage.classList.remove('active')
    }

    // Add log entry
    function addLog(message, type = 'info') {
      const entry = document.createElement('div')
      entry.className = `log-entry ${type}`
      const timestamp = new Date().toLocaleTimeString('th-TH')
      entry.textContent = `[${timestamp}] ${message}`
      elements.log.appendChild(entry)
      elements.log.scrollTop = elements.log.scrollHeight
    }

    // Initialize on page load
    initialize()
  </script>
</body>
</html>
